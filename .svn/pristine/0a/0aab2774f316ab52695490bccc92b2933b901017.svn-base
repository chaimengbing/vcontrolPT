package com.vcontrol.vcontroliot.fragment;

import android.text.TextUtils;
import android.view.View;
import android.widget.AdapterView;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ListView;
import android.widget.RelativeLayout;
import android.widget.TextView;

import com.vcontrol.vcontroliot.R;
import com.vcontrol.vcontroliot.adapter.BaseRecyclerAdapter;
import com.vcontrol.vcontroliot.adapter.UpdateBinAdapter;
import com.vcontrol.vcontroliot.log.Log;
import com.vcontrol.vcontroliot.util.ConfigParams;
import com.vcontrol.vcontroliot.util.EventNotifyHelper;
import com.vcontrol.vcontroliot.util.ServiceUtils;
import com.vcontrol.vcontroliot.util.SocketUtil;
import com.vcontrol.vcontroliot.util.ToastUtil;
import com.vcontrol.vcontroliot.util.UiEventEntry;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.util.Arrays;

/**
 * Created by Vcontrol on 2016/11/23.
 */

public class RTUVersionFragment extends BaseFragment implements View.OnClickListener, EventNotifyHelper.NotificationCenterDelegate
{

    private static final String TAG = RTUVersionFragment.class.getSimpleName();
    private TextView appVers;
    private TextView rtuVers;
    private Button updateButton;

    private UpdateBinAdapter adapter;

    private ListView updatelistView;
    private int currentType;

    private TextView downloadTextView;
    private TextView sumTextView;
    private FileInputStream binIs;
    /**
     * 文件当前包数
     */
    private int currentP = 1;
    /**
     * 文件总包数
     */
    private int fileSum;
    private long fileLength;
    //bin文件总包数，十六进制，从低到高
    private String packageSum;
    //bin文件当前包数,首先发送第一包，十六进制，从低到高
    private String packageCurrent;
    private File fileBin;
    private RelativeLayout packageLayout;
    private TextView listTextView;

    @Override
    public int getLayoutView()
    {
        return R.layout.fragment_setting_version;
    }


    @Override
    public void onDestroy()
    {
        super.onDestroy();
        EventNotifyHelper.getInstance().removeObserver(this, UiEventEntry.READ_DATA);
        EventNotifyHelper.getInstance().removeObserver(this, UiEventEntry.DOWNLOADING);
    }

    @Override
    public void initComponentViews(View view)
    {

        EventNotifyHelper.getInstance().addObserver(this, UiEventEntry.READ_DATA);
        EventNotifyHelper.getInstance().addObserver(this, UiEventEntry.DOWNLOADING);
        appVers = (TextView) view.findViewById(R.id.app_ver);
        rtuVers = (TextView) view.findViewById(R.id.rtu_ver);
        downloadTextView = (TextView) view.findViewById(R.id.download_textview);
        sumTextView = (TextView) view.findViewById(R.id.sum_data_textview);
        listTextView = (TextView) view.findViewById(R.id.list_title_textview);
        updateButton = (Button) view.findViewById(R.id.update_rtu_button);
        updatelistView = (ListView) view.findViewById(R.id.update_listview);
        packageLayout = (RelativeLayout) view.findViewById(R.id.package_layout);

        appVers.setText("APP版本：" + getAppVersion());


    }

    private String getAppVersion()
    {
        String versionName = null;

        try
        {
            versionName = getActivity().getPackageManager().getPackageInfo(
                    getActivity().getPackageName(), 0).versionName;
        } catch (Exception e)
        {

        }
        return versionName;
    }

    @Override
    public void initData()
    {
        if (getArguments() != null)
        {
            currentType = getArguments().getInt(UiEventEntry.CURRENT_RTU_NAME);
            if (currentType == UiEventEntry.WRU_2800 || currentType == UiEventEntry.WRU_2801 || currentType == UiEventEntry.WRU_2100)
            {
                SocketUtil.getSocketUtil().sendContent(ConfigParams.ReadSensorPara2);
            }
            else if (currentType == UiEventEntry.WRU_1901)
            {
                SocketUtil.getSocketUtil().sendContent(ConfigParams.ReadData);
            }
            else if (currentType == UiEventEntry.RTU_2800 || currentType == UiEventEntry.WRU_2801)
            {
                SocketUtil.getSocketUtil().sendContent(ConfigParams.ReadParameter);
            }
            else if (currentType == UiEventEntry.LRU_3000)
            {
                SocketUtil.getSocketUtil().sendContent(ConfigParams.ReadRTUVer);
            }
            else if (currentType == UiEventEntry.RCM_2000)
            {
                SocketUtil.getSocketUtil().sendContent(ConfigParams.ReadFunctionData);
            }
        }
        else
        {
            SocketUtil.getSocketUtil().sendContent(ConfigParams.ReadSensorPara2);
        }

        if (currentType == UiEventEntry.WRU_2800 || currentType == UiEventEntry.WRU_2801 || currentType == UiEventEntry.WRU_2100)
        {
            updatelistView.setVisibility(View.VISIBLE);
            packageLayout.setVisibility(View.VISIBLE);
            listTextView.setVisibility(View.VISIBLE);
        }
        else
        {
            updatelistView.setVisibility(View.GONE);
            packageLayout.setVisibility(View.GONE);
            listTextView.setVisibility(View.GONE);
        }


        adapter = new UpdateBinAdapter(getActivity());
        updatelistView.setAdapter(adapter);
    }

    @Override
    public void setListener()
    {
        updateButton.setOnClickListener(this);

        updatelistView.setOnItemClickListener(new AdapterView.OnItemClickListener()
        {
            @Override
            public void onItemClick(AdapterView<?> parent, View view, int position, long id)
            {
                File file = (File) adapter.getItem(position);
                Log.info(TAG, "file:" + file.getName());

                fileBin = new File(file.getAbsolutePath());

                //文件总大小
                fileLength = fileBin.length();
                Log.info(TAG, "length:" + fileLength);
                //bin文件总包数
                fileSum = ((int) fileLength / 1024) + 1;
                sumTextView.setText("总包数：" + fileSum);
                currentP = 1;
                sendBinData();
            }
        });

    }

    private byte[] dataSum = null;

    private void sendBinData()
    {
        //需要进行 crc 校验
        byte[] buffer = new byte[1036];
        initBuffer(buffer);

        //bin文件总包数
        packageSum = ServiceUtils.getIntLowHex(fileSum);
        //bin文件当前包数,首先发送第一包
        packageCurrent = ServiceUtils.getIntLowHex(currentP);


        String p = "0F00";
        String p1 = "0100";

        byte[] b = ServiceUtils.decodeToBytes(packageSum);
        buffer[6] = b[0];
        buffer[7] = b[1];

        byte[] b1 = ServiceUtils.decodeToBytes(packageCurrent);
        buffer[8] = b1[0];
        buffer[9] = b1[1];

        try
        {
            if (binIs == null)
            {
                dataSum = new byte[(int) fileLength];
                binIs = new FileInputStream(fileBin);
                binIs.read(dataSum);

            }
//            Log.info(TAG,Arrays.toString(dataSum));
            byte[] data = new byte[1024];
            int temtLength = 1024 * (currentP - 1);
            if (currentP == fileSum)
            {//发送最后一包数据
                int length = (int) (fileLength - temtLength);
//                Log.info(TAG, "length:" + length);
                System.arraycopy(dataSum, temtLength, data, 0, length);

                //最后一包数据不到1024的补"0A"
                for (int i = length; i < data.length; i++)
                {
                    data[i] = 0x0A;
                }

            }
            else
            {
                System.arraycopy(dataSum, temtLength, data, 0, data.length);
            }

            for (int i = 0; i < 1024; i++)
            {
                buffer[i + 12] = data[i];
            }
            //crc 校验值
            String crcValue = ServiceUtils.getIntLowHex(ServiceUtils.calcCrc16(buffer));
//            Log.info(TAG, "crcValue:" + Arrays.toString(buffer));
            String content = ServiceUtils.toHexString(ConfigParams.DOWNLOAD) + ServiceUtils.byteArrayToHexStr(buffer) + crcValue + ConfigParams.DOWNLOADEND;
            Log.info(TAG, "content:" + content);
            byte[] sendData = ServiceUtils.decodeToBytes(content);
//            Log.info(TAG, "sendData:" + Arrays.toString(sendData));
            SocketUtil.getSocketUtil().sendContent(sendData, true);
            downloadTextView.setText("正在发送第" + currentP + "包数据");
        } catch (Exception e)
        {
            Log.exception(TAG, e);
        }
    }

    /**
     * 第6、7字节为总包数
     * 第8、9字节为当前
     *o
     * @param buffer 进行CRC校验的buffer
     */
    private void initBuffer(byte[] buffer)
    {
        buffer[0] = 0x55;
        buffer[1] = 0x01;
        buffer[2] = 0x00;
        buffer[3] = 0x00;
        buffer[4] = 0x00;
        buffer[5] = 0x50;
//        buffer[6] = 0x0f;
//        buffer[7] = 0x00;
//        buffer[8] = 0x01;
//        buffer[9] = 0x00;
        buffer[10] = 0x00;
        buffer[11] = 0x04;
//        buffer[12] = 0x01;
//
//        for (int i = 13; i < 1036; i++)
//        {
//            buffer[i] = 0x0A;
//        }
    }

    @Override
    public void onClick(View view)
    {
        switch (view.getId())
        {
            case R.id.update_rtu_button:
                ToastUtil.showToastLong("更新");
                break;
            default:
                break;
        }
    }

    @Override
    public void didReceivedNotification(int id, Object... args)
    {
        if (id == UiEventEntry.READ_DATA)
        {
            String result = (String) args[0];
            if (TextUtils.isEmpty(result))
            {
                return;
            }

            setData(result);
        }
        else if (id == UiEventEntry.DOWNLOADING)
        {
            String download = (String) args[0];
            if (TextUtils.isEmpty(download))
            {
                return;
            }
            handDownLoad(download);
        }
    }

    /**
     * 处理RTU返回数据
     *
     * @param download :RTU返回的数据
     */
    private void handDownLoad(String download)
    {
        String data = download.replaceAll(ConfigParams.DOWNLOAD, "");
        data = data.replace(" ok", "");
        String tempP = data.replaceAll(" ", "0").trim();
        Log.info(TAG, "temp:" + tempP);
        if (tempP.equals(packageSum))
        {//接收包数与总包数相同，发送完成
            ToastUtil.showToastLong("成功发送升级文件到设备!");
            //接收完毕
            try
            {
                SocketUtil.getSocketUtil().setDownload(false);
                if (binIs!= null)
                {
                    binIs.close();
                    binIs = null;
                }
                dataSum = null;
            } catch (IOException e)
            {
                e.printStackTrace();
            }
        }
        else if (tempP.equals(packageCurrent))
        {
            currentP++;
            sendBinData();
        }
    }

    public void setData(String data)
    {
        if (currentType == UiEventEntry.WRU_2801 || currentType == UiEventEntry.WRU_2800 || currentType == UiEventEntry.WRU_2100)
        {
            if (data.contains(ConfigParams.Ver))
            {
                String ver = data.replaceAll(ConfigParams.Ver, "").trim();
                Log.debug(TAG, "Version:" + ver);
                rtuVers.setText(ver);
            }
        }
        else if (currentType == UiEventEntry.WRU_1901)
        {
            if (data.contains(ConfigParams.GROUND_Ver))
            {

                String ver = data.replaceAll(ConfigParams.GROUND_Ver, "").trim();
                Log.debug(TAG, "Version:" + ver);
                rtuVers.setText(ver);
            }
        }
        else if (currentType == UiEventEntry.LRU_3000)
        {
            if (data.contains(ConfigParams.ReadRTUVer))
            {

                String ver = data.replaceAll(ConfigParams.ReadRTUVer, "").trim();
                Log.debug(TAG, "Version:" + ver);
                rtuVers.setText(ver);
            }
        }
        else if (currentType == UiEventEntry.RTU_2800 || currentType == UiEventEntry.RTU_2801)
        {
            if (data.contains(ConfigParams.SoftVer))
            {
                String ver = data.replaceAll(ConfigParams.SoftVer, "").trim();
                Log.debug(TAG, "Version:" + ver);
                rtuVers.setText(ver);
            }
        }
        else if (currentType == UiEventEntry.RCM_2000)
        {
            if (data.contains(ConfigParams.SoftVer))
            {
                String ver = data.replaceAll(ConfigParams.SoftVer, "").trim();
                Log.debug(TAG, "Version:" + ver);
                rtuVers.setText(ver);
            }
        }
    }
}
