package com.vcontrol.vcontroliot.fragment;

import android.graphics.drawable.PaintDrawable;
import android.view.LayoutInflater;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.PopupWindow;
import android.widget.TextView;

import com.vcontrol.vcontroliot.R;
import com.vcontrol.vcontroliot.adapter.CustomAdapter;
import com.vcontrol.vcontroliot.adapter.CustomToAdapter;
import com.vcontrol.vcontroliot.log.Log;
import com.vcontrol.vcontroliot.util.CommConfig;
import com.vcontrol.vcontroliot.util.DensityUtil;
import com.vcontrol.vcontroliot.util.EventNotifyHelper;
import com.vcontrol.vcontroliot.util.ToastUtil;
import com.vcontrol.vcontroliot.util.UiEventEntry;

import java.util.ArrayList;
import java.util.List;

/**
 * Created by Vcontrol on 2016/11/22.
 */

public class RTUSettingFragment extends BaseFragment implements EventNotifyHelper.NotificationCenterDelegate, View.OnClickListener, PopupWindow.OnDismissListener
{

    private static final String TAG = RTUSettingFragment.class.getSimpleName();

    private LinearLayout setLayout;
    private TextView setTextView;
    private ImageView iconImageView;

    private ListView setListView;
    private ListView setToListView;
    private TextView sensorTextView;
    private LinearLayout sensorLayout;

    private CustomToAdapter setToAdapter;
    private CustomAdapter setAdapter;
    private String setting = "";

    private PopupWindow popupWindow;
    private List<String> setList;
    private List<String> setToList;

    @Override
    public int getLayoutView()
    {
        return R.layout.fragment_rtu_detail;
    }

    @Override
    public void initComponentViews(View view)
    {

        setLayout = (LinearLayout) view.findViewById(R.id.ll_setting);
        setTextView = (TextView) view.findViewById(R.id.set_textview);
        iconImageView = (ImageView) view.findViewById(R.id.icon_default);

        setList = new ArrayList<>();
        setToList = new ArrayList<>();

        parentActivity.clearFragmentStack(R.id.detail_layout);
        parentActivity.turnToFragmentStack(R.id.detail_layout,SystemPamarsFragment.class);
    }

    @Override
    public void onResume()
    {
        super.onResume();
        Log.debug(TAG, "onResume::");

    }

    @Override
    public void onDestroy()
    {
        super.onDestroy();
//        try
//        {
//            setList.clear();
//            setToList.clear();
//        }
//        catch (Exception e)
//        {
//            e.printStackTrace();
//        }
    }

    @Override
    public void initData()
    {
        parentActivity.setTitleRightVisible(View.VISIBLE);
        parentActivity.setTitleRight(getString(R.string.update));
        initSetData();
        initSetToData();

    }

    @Override
    public void setListener()
    {
        setLayout.setOnClickListener(this);

    }




    public void showPopupWindow(View anchor)
    {
        if (popupWindow == null)
        {
            popupWindow = new PopupWindow(getActivity());
            View contentView = LayoutInflater.from(getActivity()).inflate(
                    R.layout.windows_popupwindow, null);
            setListView = (ListView) contentView.findViewById(R.id.set_listview);
            setToListView = (ListView) contentView.findViewById(R.id.set_to_listview);
            sensorTextView = (TextView) contentView.findViewById(R.id.sensor_textview);
            sensorLayout = (LinearLayout) contentView.findViewById(R.id.sensor_layout);
            sensorTextView.setOnClickListener(this);

            popupWindow.setOnDismissListener(this);
            popupWindow.setWidth(DensityUtil.getDisplayWidthPixels(getActivity()));
            popupWindow.setHeight(DensityUtil.getDisplayHeightPixels(getActivity()));
            popupWindow.setContentView(contentView);
            popupWindow.setFocusable(true);
            popupWindow.setOutsideTouchable(true);
            popupWindow.setBackgroundDrawable(new PaintDrawable());
        }

        setAdapter = new CustomAdapter(getActivity(), setList);
        setListView.setAdapter(setAdapter);
        setListView.setOnItemClickListener(new AdapterView.OnItemClickListener()
        {

            @Override
            public void onItemClick(AdapterView<?> parent, View view,
                                    int position, long id)
            {
                if (parent.getAdapter() instanceof CustomAdapter)
                {
                    setting = setList.get(position);
                    if (sensorLayout.getVisibility() == View.GONE && position == 4)
                    {
                        sensorLayout.setVisibility(View.VISIBLE);
                        setListView.setVisibility(View.GONE);
                        setToAdapter = new CustomToAdapter(getActivity(),
                                setToList);
                        setToListView.setAdapter(setToAdapter);
                        setToListView.setOnItemClickListener(new AdapterView.OnItemClickListener()
                        {

                            @Override
                            public void onItemClick(AdapterView<?> parent,
                                                    View view, int position, long id)
                            {
                                popupWindow.dismiss();
                                setting = setToList.get(position);
                                ToastUtil.showToastLong(setToList.get(position));
                            }
                        });
                    }
                    else
                    {
                        popupWindow.dismiss();
                        ToastUtil.showToastLong(setList.get(position));
                        if (position == UiEventEntry.NOTIFY_SYSTEM_PAMARS)
                        {
                            parentActivity.turnToFragmentStack(R.id.detail_layout,SystemPamarsFragment.class);
                        }
                        else if (position == UiEventEntry.NOTIFY_COLLECT)
                        {
                            parentActivity.turnToFragmentStack(R.id.detail_layout,CollectFragment.class);
                        }
                        else if (position == UiEventEntry.NOTIFY_COMM_PAMARS)
                        {
                            parentActivity.turnToFragmentStack(R.id.detail_layout,CommParamsFragment.class);
                        }
                        else if (position == UiEventEntry.NOTIFY_CHANNEL_PAMARS)
                        {
                            parentActivity.turnToFragmentStack(R.id.detail_layout,ChannelFragment.class);
                        }
                        else if (position == UiEventEntry.NOTIFY_AD_PAMARS)
                        {
                            parentActivity.turnToFragmentStack(R.id.detail_layout,ADFragment.class);
                        }
                    }
                    setTextView.setText(setting);
                }
            }
        });
        popupWindow.showAsDropDown(anchor);

    }

    private void initSetToData()
    {

        setToList.add(getString(R.string.rain_pamars));
        setToList.add(getString(R.string.water_pamars));
        setToList.add(getString(R.string.water_plan));
        setToList.add(getString(R.string.camera));
        setToList.add(getString(R.string.shangqing));
        setToList.add(getString(R.string.gprs_plan));
        setToList.add(getString(R.string.zawei_plan));
        setToList.add(getString(R.string.ather_pamars));

    }

    private void initSetData()
    {
        setList.add(getString(R.string.system_params_setting));
        setList.add(getString(R.string.collect_setting));
        setList.add(getString(R.string.comm_params_setting));
        setList.add(getString(R.string.channel_setting));
        setList.add(getString(R.string.sensor_setting));
        setList.add(getString(R.string.ad_setting));
    }


    @Override
    public void didReceivedNotification(int id, Object... args)
    {
    }

    @Override
    public void onClick(View view)
    {
        switch (view.getId())
        {
            case R.id.ll_setting:
                iconImageView.setImageResource(R.mipmap.icon_sel);
                showPopupWindow(setLayout);
                break;
            case R.id.sensor_textview:
                sensorLayout.setVisibility(View.GONE);
                setListView.setVisibility(View.VISIBLE);
                break;
        }
    }

    @Override
    public void onDismiss()
    {
        iconImageView.setImageResource(R.mipmap.icon_default);
    }

}
