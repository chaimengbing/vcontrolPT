package com.vcontrol.vcontroliot.fragment;

import android.text.TextUtils;
import android.util.Log;
import android.view.View;
import android.widget.AdapterView;
import android.widget.Button;
import android.widget.EditText;
import android.widget.LinearLayout;
import android.widget.RadioGroup;
import android.widget.Spinner;

import com.vcontrol.vcontroliot.R;
import com.vcontrol.vcontroliot.adapter.SimpleSpinnerAdapter;
import com.vcontrol.vcontroliot.util.ConfigParams;
import com.vcontrol.vcontroliot.util.EventNotifyHelper;
import com.vcontrol.vcontroliot.util.ServiceUtils;
import com.vcontrol.vcontroliot.util.SocketUtil;
import com.vcontrol.vcontroliot.util.ToastUtil;
import com.vcontrol.vcontroliot.util.UiEventEntry;

import java.util.IllegalFormatCodePointException;

/**
 * Created by Vcontrol on 2016/11/23.
 */

public class CommParamsFragment extends BaseFragment implements View.OnClickListener, AdapterView.OnItemSelectedListener, EventNotifyHelper.NotificationCenterDelegate
{

    private Spinner timeSpinner;
    private Spinner picSpinner;
    private String[] timeItems;
    private SimpleSpinnerAdapter timeAdapter;

    private LinearLayout time1;
    private LinearLayout time2;

    private boolean isSelectTime = true;

    private Spinner commTypeSpinner;
    private String[] commItems;
    private SimpleSpinnerAdapter commAdapter;

    private EditText center1AddEdittext;
    private EditText center2AddEdittext;
    private EditText center3AddEdittext;
    private EditText center4AddEdittext;
    private EditText dayBeginEdittext;
    private EditText timeEdittext;
    private EditText apnEdittext;
    private EditText apnPsdEdittext;
    private EditText commPsdEdittext;
    private EditText commNumEdittext;

    private Button center1AddButton;
    private Button center2AddButton;
    private Button center3AddButton;
    private Button center4AddButton;
    private Button dayBeginButton;
    private Button commNumButton;
    private Button timeButton;
    private Button apnButton;
    private Button apnPsdButton;
    private Button commPsdButton;

    // 召测
    private RadioGroup callTestGroup;


    @Override
    public int getLayoutView()
    {
        return R.layout.fragment_setting_comm_prmams1;
    }

    @Override
    public void onDestroy()
    {
        super.onDestroy();
        EventNotifyHelper.getInstance().removeObserver(this, UiEventEntry.READ_DATA);
    }

    @Override
    public void initComponentViews(View view)
    {

        EventNotifyHelper.getInstance().addObserver(this, UiEventEntry.READ_DATA);
        timeSpinner = (Spinner) view.findViewById(R.id.time_interval_spinner);
        picSpinner = (Spinner) view.findViewById(R.id.pic_interval_spinner);
        commTypeSpinner = (Spinner) view.findViewById(R.id.comm_type_spinner);
        callTestGroup = (RadioGroup) view.findViewById(R.id.call_test_radiogroup);


        center1AddEdittext = (EditText) view.findViewById(R.id.center_1_add_edittext);
        center2AddEdittext = (EditText) view.findViewById(R.id.center_2_add_edittext);
        center3AddEdittext = (EditText) view.findViewById(R.id.center_3_add_edittext);
        center4AddEdittext = (EditText) view.findViewById(R.id.center_4_add_edittext);
        commNumEdittext = (EditText) view.findViewById(R.id.comm_num_edittext);
        dayBeginEdittext = (EditText) view.findViewById(R.id.day_begin_edittext);
        apnEdittext = (EditText) view.findViewById(R.id.apn_edittext);
        timeEdittext = (EditText) view.findViewById(R.id.time_interval_edittext);
        apnPsdEdittext = (EditText) view.findViewById(R.id.apn_psd_edittext);
        commPsdEdittext = (EditText) view.findViewById(R.id.comm_psd_edittext);

        center1AddButton = (Button) view.findViewById(R.id.center_1_add_button);
        center2AddButton = (Button) view.findViewById(R.id.center_2_add_button);
        center3AddButton = (Button) view.findViewById(R.id.center_3_add_button);
        center4AddButton = (Button) view.findViewById(R.id.center_4_add_button);
        commNumButton = (Button) view.findViewById(R.id.comm_num_button);
        timeButton = (Button) view.findViewById(R.id.time_interval_button);
        dayBeginButton = (Button) view.findViewById(R.id.day_begin_add_button);
        apnButton = (Button) view.findViewById(R.id.apn_set_button);
        apnPsdButton = (Button) view.findViewById(R.id.apn_psd_button);
        commPsdButton = (Button) view.findViewById(R.id.comm_psd_button);

        time1 = (LinearLayout) view.findViewById(R.id.time1);
        time2 = (LinearLayout) view.findViewById(R.id.time2);

        if (isSelectTime)
        {
            time1.setVisibility(View.GONE);
            time2.setVisibility(View.VISIBLE);
        }
        else
        {
            time2.setVisibility(View.GONE);
            time1.setVisibility(View.VISIBLE);
        }

        initView(view);

    }

    private void initView(final View v)
    {
        callTestGroup.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener()
        {

            @Override
            public void onCheckedChanged(RadioGroup group, int checkedId)
            {
                View checkView = v.findViewById(checkedId);
                if (!checkView.isPressed())
                {
                    return;
                }
                String content = ConfigParams.SetAcquisitionMode;
                if (checkedId == R.id.call_test)
                {
                    SocketUtil.sendData(content + "0");
                }
                else if (checkedId == R.id.no_call_test)
                {
                    SocketUtil.sendData(content + "1");

                }

            }
        });


    }

    @Override
    public void initData()
    {
        timeItems = getResources().getStringArray(R.array.time_interval);
        timeAdapter = new SimpleSpinnerAdapter(getActivity(), R.layout.simple_spinner_item, timeItems);
        timeSpinner.setAdapter(timeAdapter);
        picSpinner.setAdapter(timeAdapter);

        commItems = getResources().getStringArray(R.array.comm_type);
        commAdapter = new SimpleSpinnerAdapter(getActivity(), R.layout.simple_spinner_item, commItems);
        commTypeSpinner.setAdapter(commAdapter);

        SocketUtil.sendData(ConfigParams.ReadCommPara1);
    }

    @Override
    public void setListener()
    {
        center1AddButton.setOnClickListener(this);
        center2AddButton.setOnClickListener(this);
        center3AddButton.setOnClickListener(this);
        center4AddButton.setOnClickListener(this);
        dayBeginButton.setOnClickListener(this);
        apnButton.setOnClickListener(this);
        apnPsdButton.setOnClickListener(this);
        timeButton.setOnClickListener(this);
        commPsdButton.setOnClickListener(this);
        commNumButton.setOnClickListener(this);
    }

    @Override
    public void onClick(View view)
    {
        String centerAdd = "";
        int centerNum = -1;
        switch (view.getId())
        {
            case R.id.center_1_add_button:

                centerAdd = center1AddEdittext.getText().toString().trim();
                if (TextUtils.isEmpty(centerAdd))
                {
                    ToastUtil.showToastLong("地址不能为空！");
                    return;
                }

                centerNum = Integer.parseInt(centerAdd);
                if (centerNum < 0 || centerNum > 255)
                {
                    ToastUtil.showToastLong("地址范围是0-255，请重新输入！");
                    return;
                }
                SocketUtil.sendData(ConfigParams.Setcenternumber + "1 " + ServiceUtils.getStr(centerAdd, 3));

                break;
            case R.id.center_2_add_button:
                centerAdd = center2AddEdittext.getText().toString().trim();
                if (TextUtils.isEmpty(centerAdd))
                {
                    ToastUtil.showToastLong("地址不能为空！");
                    return;
                }

                centerNum = Integer.parseInt(centerAdd);
                if (centerNum < 0 || centerNum > 255)
                {
                    ToastUtil.showToastLong("地址范围是0-255，请重新输入！");
                    return;
                }
                SocketUtil.sendData(ConfigParams.Setcenternumber + "2 " + ServiceUtils.getStr(centerAdd, 3));

                break;
            case R.id.center_3_add_button:
                centerAdd = center3AddEdittext.getText().toString().trim();
                if (TextUtils.isEmpty(centerAdd))
                {
                    ToastUtil.showToastLong("地址不能为空！");
                    return;
                }

                centerNum = Integer.parseInt(centerAdd);
                if (centerNum < 0 || centerNum > 255)
                {
                    ToastUtil.showToastLong("地址范围是0-255，请重新输入！");
                    return;
                }
                SocketUtil.sendData(ConfigParams.Setcenternumber + "3 " + ServiceUtils.getStr(centerAdd, 3));

                break;
            case R.id.center_4_add_button:
                centerAdd = center4AddEdittext.getText().toString().trim();
                if (TextUtils.isEmpty(centerAdd))
                {
                    ToastUtil.showToastLong("地址不能为空！");
                    return;
                }

                centerNum = Integer.parseInt(centerAdd);
                if (centerNum < 0 || centerNum > 255)
                {
                    ToastUtil.showToastLong("地址范围是0-255，请重新输入！");
                    return;
                }
                SocketUtil.sendData(ConfigParams.Setcenternumber + "4 " + ServiceUtils.getStr(centerAdd, 3));

                break;
            case R.id.day_begin_add_button:
                centerAdd = dayBeginEdittext.getText().toString().trim();
                if (TextUtils.isEmpty(centerAdd))
                {
                    ToastUtil.showToastLong("日起始时间不能为空！");
                    return;
                }

                centerNum = Integer.parseInt(centerAdd);
                if (centerNum < 0 || centerNum > 23)
                {
                    ToastUtil.showToastLong("日起始时间范围是0-23，请重新输入！");
                    return;
                }
                SocketUtil.sendData(ConfigParams.SetSendBeginTime + ServiceUtils.getStr(centerAdd, 2));

                break;
            case R.id.comm_num_button:
                centerAdd = commNumEdittext.getText().toString().trim();

                if (TextUtils.isEmpty(centerAdd))
                {
                    ToastUtil.showToastLong("通信识别吗不能为空！");
                    return;
                }
                SocketUtil.sendData(ConfigParams.SetSMS + "5" + " " + ServiceUtils.getStr(centerAdd, 11));

                break;
            case R.id.apn_set_button:
                centerAdd = apnEdittext.getText().toString().trim();
                if (TextUtils.isEmpty(centerAdd))
                {
                    ToastUtil.showToastLong("APN不能为空！");
                    return;
                }


                SocketUtil.sendData(ConfigParams.SetAPN + centerAdd);

                break;
            case R.id.apn_psd_button:
                centerAdd = apnPsdEdittext.getText().toString().trim();
                if (TextUtils.isEmpty(centerAdd))
                {
                    ToastUtil.showToastLong("APN密码不能为空！");
                    return;
                }


                SocketUtil.sendData(ConfigParams.SetAP_N_secret + centerAdd);

                break;
            case R.id.comm_psd_button:
                centerAdd = commPsdEdittext.getText().toString().trim();
                if (TextUtils.isEmpty(centerAdd))
                {
                    ToastUtil.showToastLong("通信密码不能为空！");
                    return;
                }

                centerNum = Integer.parseInt(centerAdd);
                if (centerNum < 0 || centerNum > 65535)
                {
                    ToastUtil.showToastLong("通信密码范围是0-65535，请重新输入！");
                    return;
                }
                SocketUtil.sendData(ConfigParams.SetComPassword + ServiceUtils.getStr(centerAdd, 5));

                break;
            case R.id.time_interval_button:
                centerAdd = timeEdittext.getText().toString().trim();
                if (TextUtils.isEmpty(centerAdd))
                {
                    ToastUtil.showToastLong("定时报间隔不能为空！");
                    return;
                }

                centerNum = Integer.parseInt(centerAdd);
                if (centerNum < 0 || centerNum > 999)
                {
                    ToastUtil.showToastLong("定时报间隔的范围是0-999，请重新输入！");
                    return;
                }
                SocketUtil.sendData(ConfigParams.SetPacketInterval + ServiceUtils.getStr(centerAdd, 3));

                break;

            default:
                break;
        }
    }

    @Override
    public void onItemSelected(AdapterView<?> adapterView, View view, int i, long l)
    {
        timeAdapter.setSelectedItem(i);

        String content = ConfigParams.SetPacketInterval + ServiceUtils.getTimeNum(timeItems[i]);
        SocketUtil.sendData(content);

    }

    @Override
    public void onNothingSelected(AdapterView<?> adapterView)
    {

    }

    @Override
    public void didReceivedNotification(int id, Object... args)
    {
        String result = (String) args[0];
        String content = (String) args[1];
        if (TextUtils.isEmpty(result) || TextUtils.isEmpty(content))
        {
            return;
        }
        setData(result);
    }

    private void setData(String result)
    {
        String data = "";
        if (result.contains(ConfigParams.SetPacketInterval))
        {// 定时报间隔
            data = result.replaceAll(ConfigParams.SetPacketInterval.trim(), "").trim();
            if (isSelectTime)
            {
                if (ServiceUtils.isNumeric(data))
                {
                    int t = Integer.parseInt(data);
                    timeSpinner.setSelection(ServiceUtils.getTimePos(t), false);
                    timeSpinner.setOnItemSelectedListener(this);
                }
            }
            else
            {
                timeEdittext.setText(data);
            }


        }
        if (result.contains(ConfigParams.PicSendInterval))
        {// 定时报间隔
            data = result.replaceAll(ConfigParams.PicSendInterval.trim(), "").trim();

            if (ServiceUtils.isNumeric(data))
            {
                int t = Integer.parseInt(data);
                if (t < timeItems.length)
                {
                    picSpinner.setSelection(ServiceUtils.getTimePos(t), false);
                }
                else
                {
                    picSpinner.setSelection(0, false);
                }
                picSpinner.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener()
                {
                    @Override
                    public void onItemSelected(AdapterView<?> parent, View view, int position, long id)
                    {
                        timeAdapter.setSelectedItem(position);
                        String content = ConfigParams.PicSendInterval + ServiceUtils.getTimeNum(timeItems[position]);
                        SocketUtil.sendData(content);
                    }

                    @Override
                    public void onNothingSelected(AdapterView<?> parent)
                    {

                    }
                });

            }

        }
        else if (result.contains(ConfigParams.SetprotocolType))
        {// 通信协议
            data = result.replaceAll(ConfigParams.SetprotocolType.trim(), "").trim();
            if (ServiceUtils.isNumeric(data))
            {
                int t = Integer.parseInt(data);
                commTypeSpinner.setSelection(t, false);
                commTypeSpinner.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener()
                {
                    @Override
                    public void onItemSelected(AdapterView<?> adapterView, View view, int i, long l)
                    {
                        commAdapter.setSelectedItem(i);
                        if (i == 0)
                        {
                            return;
                        }

                        String content = ConfigParams.SetprotocolType + ServiceUtils.getStr(i + "", 2);
                        SocketUtil.sendData(content);
                    }

                    @Override
                    public void onNothingSelected(AdapterView<?> adapterView)
                    {

                    }
                });
            }
        }
        else if (result.contains(ConfigParams.SetAcquisitionMode.trim()))
        {// 召测模式
            data = result.replaceAll(ConfigParams.SetAcquisitionMode, "").trim();
            if (data.equals("0"))
            {
                callTestGroup.check(R.id.call_test);
            }
            else
            {
                callTestGroup.check(R.id.no_call_test);
            }
        }
        // 日起始时间
        else if (result.contains(ConfigParams.SetSendBeginTime))
        {
            data = result.replaceAll(ConfigParams.SetSendBeginTime, "").trim();
            dayBeginEdittext.setText(data);
        }
        // 通信识别码
        else if (result.contains(ConfigParams.SetSMS + "5"))
        {
            data = result.replaceAll(ConfigParams.SetSMS + "5", "").trim();
            commNumEdittext.setText(data);
        }
        // 中心站地址 1 2 3 4
        else if (result.contains(ConfigParams.Setcenternumber + "1"))
        {
            data = result.replaceAll(ConfigParams.Setcenternumber + "1", "").trim();
            center1AddEdittext.setText(data);
        }
        else if (result.contains(ConfigParams.Setcenternumber + "2"))
        {
            data = result.replaceAll(ConfigParams.Setcenternumber + "2", "").trim();
            center2AddEdittext.setText(data);
        }
        else if (result.contains(ConfigParams.Setcenternumber + "3"))
        {
            data = result.replaceAll(ConfigParams.Setcenternumber + "3", "").trim();
            center3AddEdittext.setText(data);
        }
        else if (result.contains(ConfigParams.Setcenternumber + "4"))
        {
            data = result.replaceAll(ConfigParams.Setcenternumber + "4", "").trim();
            center4AddEdittext.setText(data);
        }
        else if (result.contains(ConfigParams.SetAPN))
        {
            data = result.replaceAll(ConfigParams.SetAPN, "").trim();
            apnEdittext.setText(data);
        }
        else if (result.contains(ConfigParams.SetAP_N_secret))
        {
            data = result.replaceAll(ConfigParams.SetAP_N_secret, "").trim();
            apnPsdEdittext.setText(data);
        }
        else if (result.contains(ConfigParams.SetComPassword))
        {
            data = result.replaceAll(ConfigParams.SetComPassword, "").trim();
            commPsdEdittext.setText(data);
        }
    }

}
