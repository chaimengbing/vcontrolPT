package com.vcontrol.vcontroliot.fragment;

import android.os.Bundle;
import android.text.TextUtils;
import android.view.View;
import android.widget.AdapterView;
import android.widget.Button;
import android.widget.CompoundButton;
import android.widget.EditText;
import android.widget.LinearLayout;
import android.widget.RadioButton;
import android.widget.RadioGroup;
import android.widget.RelativeLayout;
import android.widget.Spinner;
import android.widget.Switch;
import android.widget.TextView;

import com.vcontrol.vcontroliot.R;
import com.vcontrol.vcontroliot.adapter.SimpleSpinnerAdapter;
import com.vcontrol.vcontroliot.log.Log;
import com.vcontrol.vcontroliot.util.ConfigParams;
import com.vcontrol.vcontroliot.util.EventNotifyHelper;
import com.vcontrol.vcontroliot.util.ServiceUtils;
import com.vcontrol.vcontroliot.util.SocketUtil;
import com.vcontrol.vcontroliot.util.ToastUtil;
import com.vcontrol.vcontroliot.util.UiEventEntry;

import java.text.SimpleDateFormat;

/**
 * Created by Vcontrol on 2016/11/23.
 */

public class SystemPamarsFragment extends BaseFragment implements View.OnClickListener, AdapterView.OnItemSelectedListener, EventNotifyHelper.NotificationCenterDelegate
{

    private static final String DEFAULT_TIME_FORMAT = "yyyy年MM月dd日HH时mm分ss秒";
    private static final String SEND_TIME_FORMAT = "yyyyMMddHHmmss";
    private static final String TAG = SystemPamarsFragment.class.getSimpleName();


    private EditText siteTestEditText;
    private Button siteTestSetButton;
    private EditText xingEditText;
    private EditText deviceEditText;
    private Spinner siteTypeSpinner;
    private Button xingSetButton;

    private Button deviceSetButton;
    private SimpleSpinnerAdapter siteTypeAdapter;
    private String[] siteTypeItems;
    private RadioGroup runStatusRadioGroup;
    private RadioGroup siteNumRadioGroup;
    private RadioButton alwaysRadioButton;
    private RadioButton lowRadioButton;

    //    private Runnable mTimeUpdateThread;
    private Button resetFactoryButton;
    private Button saveResetButton;
    //    private TextView currentTime;
    private TextView rtuTimeTextView;
    private Button timeButton;
    private SimpleDateFormat sendTimeFormat;
    private SimpleDateFormat timeFormat;
    private LinearLayout xingLinearLayout;

    private Switch elecrelaySwitch;

    //是不是8位站号
    private boolean is8Add = true;

    private RelativeLayout elecrelayLayout;
    private String setTime = "";
    private int currentType = -1;



    @Override
    public int getLayoutView()
    {
        return R.layout.fragment_setting_system_pamars1;
    }

    @Override
    public void onDestroy()
    {
        super.onDestroy();
        EventNotifyHelper.getInstance().removeObserver(this, UiEventEntry.READ_DATA);
        EventNotifyHelper.getInstance().removeObserver(this, UiEventEntry.SELECT_TIME);
    }

    @Override
    public void initComponentViews(View view)
    {

        EventNotifyHelper.getInstance().addObserver(this, UiEventEntry.READ_DATA);
        EventNotifyHelper.getInstance().addObserver(this, UiEventEntry.SELECT_TIME);

        xingLinearLayout = (LinearLayout) view.findViewById(R.id.ll_xingzheng);
        xingLinearLayout.setVisibility(View.GONE);

        siteTestSetButton = (Button) view.findViewById(R.id.site_test_setting_button);
        xingSetButton = (Button) view.findViewById(R.id.xingzheng_setting_button);
        siteTestEditText = (EditText) view.findViewById(R.id.site_test_add_number);
        xingEditText = (EditText) view.findViewById(R.id.xingzheng_number);
        deviceSetButton = (Button) view.findViewById(R.id.device_id_setting_button);
        deviceEditText = (EditText) view.findViewById(R.id.device_id);
        siteTypeSpinner = (Spinner) view.findViewById(R.id.site_type_spinner);

        runStatusRadioGroup = (RadioGroup) view.findViewById(R.id.run_status);
        siteNumRadioGroup = (RadioGroup) view.findViewById(R.id.site_num);
        siteNumRadioGroup.check(R.id.site_num_8);
        lowRadioButton = (RadioButton) view.findViewById(R.id.low_power_radiobtton);
        alwaysRadioButton = (RadioButton) view.findViewById(R.id.always_online_radiobtton);
        resetFactoryButton = (Button) view.findViewById(R.id.reset_factory);
        saveResetButton = (Button) view.findViewById(R.id.save_and_reset);
        timeButton = (Button) view.findViewById(R.id.time_button);
//        currentTime = (TextView) view.findViewById(R.id.current_time);
        rtuTimeTextView = (TextView) view.findViewById(R.id.rtu_time);
        elecrelaySwitch = (Switch) view.findViewById(R.id.elecrelay_switch);
        elecrelayLayout = (RelativeLayout) view.findViewById(R.id.elecrelay_layout);
        initView(view);

        Bundle bundle = getArguments();
        if (bundle != null)
        {
            currentType = bundle.getInt(UiEventEntry.CURRENT_RTU_NAME);
            if (currentType == UiEventEntry.WRU_2801)
            {
                elecrelayLayout.setVisibility(View.GONE);
            }
        }

    }

    @Override
    public void initData()
    {
        siteTypeItems = getResources().getStringArray(R.array.site_type);
        siteTypeAdapter = new SimpleSpinnerAdapter(getActivity(), R.layout.simple_spinner_item, siteTypeItems);
        siteTypeSpinner.setAdapter(siteTypeAdapter);

        SocketUtil.getSocketUtil().sendContent(ConfigParams.ReadSystemPara);

        timeFormat = new SimpleDateFormat(DEFAULT_TIME_FORMAT);
        sendTimeFormat = new SimpleDateFormat(SEND_TIME_FORMAT);

        ServiceUtils.getServiceUtils().initContent();

//        mTimeUpdateThread = new Runnable()
//        {
//            @Override
//            public void run()
//            {
//                try
//                {
//                    VcontrolApplication.applicationHandler.postDelayed(mTimeUpdateThread, 1000);
////                    currentTime.setText(timeFormat.format(System.currentTimeMillis()));
//                } catch (Exception e)
//                {
//                    e.printStackTrace();
//                }
//            }
//        };
//        VcontrolApplication.applicationHandler.post(mTimeUpdateThread);
    }

    private void initView(final View view)
    {
        runStatusRadioGroup.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener()
        {
            @Override
            public void onCheckedChanged(RadioGroup radioGroup, int i)
            {
                View checkView = view.findViewById(i);
                if (!checkView.isPressed())
                {
                    return;
                }
                String content = ConfigParams.SetWorkMode;
                switch (i)
                {
                    case R.id.low_power_radiobtton:
                        String low = content + "0";
                        SocketUtil.getSocketUtil().sendContent(low);

                        break;
                    case R.id.always_online_radiobtton:
                        String always = content + "1";
                        SocketUtil.getSocketUtil().sendContent(always);

                        break;

                    default:
                        break;
                }
            }
        });
        siteNumRadioGroup.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener()
        {
            @Override
            public void onCheckedChanged(RadioGroup radioGroup, int i)
            {
                View checkView = view.findViewById(i);
                if (!checkView.isPressed())
                {
                    return;
                }
                String content = ConfigParams.SetId_Type;
                switch (i)
                {
                    case R.id.site_num_8:
                        String low = content + "0";
                        SocketUtil.getSocketUtil().sendContent(low);
                        is8Add = true;
                        xingLinearLayout.setVisibility(View.GONE);

                        break;
                    case R.id.site_num_10:
                        String always = content + "1";
                        SocketUtil.getSocketUtil().sendContent(always);

                        is8Add = false;
                        xingLinearLayout.setVisibility(View.VISIBLE);


                        break;


                    default:
                        break;
                }
            }
        });
    }

    @Override
    public void setListener()
    {
        deviceSetButton.setOnClickListener(this);
        siteTestSetButton.setOnClickListener(this);
        xingSetButton.setOnClickListener(this);
        resetFactoryButton.setOnClickListener(this);
        saveResetButton.setOnClickListener(this);
        timeButton.setOnClickListener(this);
        rtuTimeTextView.setOnClickListener(this);


        elecrelaySwitch.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener()
        {
            @Override
            public void onCheckedChanged(CompoundButton buttonView, boolean isChecked)
            {
                if (isChecked)
                {
                    SocketUtil.getSocketUtil().sendContent(ConfigParams.elecrelay + "1");
                }
                else
                {
                    SocketUtil.getSocketUtil().sendContent(ConfigParams.elecrelay + "0");

                }
            }
        });
    }

    @Override
    public void onClick(View view)
    {

        switch (view.getId())
        {
            case R.id.device_id_setting_button:

                String deviceid = deviceEditText.getText().toString();
                if (TextUtils.isEmpty(deviceid))
                {
                    ToastUtil.showToastLong("设备ID不能为空！");
                    return;
                }

                if (deviceid.length() == 14)
                {
                    String content1 = ConfigParams.SetRTUid18 + deviceid;
                    SocketUtil.getSocketUtil().sendContent(content1);
                }
                else
                {
                    ToastUtil.showToastLong("设备ID位数不等于14位，请重新输入！");
                }


                break;
            case R.id.site_test_setting_button:

                String number = siteTestEditText.getText().toString();
                if (TextUtils.isEmpty(number))
                {
                    ToastUtil.showToastLong("地址不能为空！");
                    return;
                }
                if (number.length() > 10)
                {
                    return;
                }
                String ss = "";
                if (number.length() < 10)
                {
                    for (int i = 0; i < 10 - number.length(); i++)
                    {
                        ss += "0";
                    }
                }
                String content;
                if (is8Add)
                {
                    content = ConfigParams.SetAddr + ss + number;
                }
                else
                {
                    content = ConfigParams.SetRTUidyc + ServiceUtils.getStr(number, 5);
                }


                SocketUtil.getSocketUtil().sendContent(content);
                break;
            case R.id.xingzheng_setting_button:
                if (is8Add)
                {
                    return;
                }

                String xing = xingEditText.getText().toString();
                if (TextUtils.isEmpty(xing))
                {
                    ToastUtil.showToastLong("行政区划码不能为空！");
                    return;
                }
                String co = ConfigParams.SetRTUidxz + ServiceUtils.getStr(xing, 6);

                SocketUtil.getSocketUtil().sendContent(co);
                break;

            case R.id.reset_factory:
                SocketUtil.getSocketUtil().sendContent(ConfigParams.RESETALL);
                break;
            case R.id.save_and_reset:
                SocketUtil.getSocketUtil().sendContent(ConfigParams.RESETUNIT);
                break;
            case R.id.time_button:
                if (TextUtils.isEmpty(setTime))
                {
                    SocketUtil.getSocketUtil().sendContent(ConfigParams.SETTIME + sendTimeFormat.format(System.currentTimeMillis()));
                }
                else
                {
                    SocketUtil.getSocketUtil().sendContent(ConfigParams.SETTIME + setTime);
                }
                break;

            case R.id.rtu_time:
                 ServiceUtils.getServiceUtils().seletDate(getActivity());
                break;

            default:
                break;
        }
    }

    @Override
    public void onItemSelected(AdapterView<?> adapterView, View view, int i, long l)
    {
        siteTypeAdapter.setSelectedItem(i);

        String content = ConfigParams.SetStationMode + i;
        SocketUtil.getSocketUtil().sendContent(content);
    }

    @Override
    public void onNothingSelected(AdapterView<?> adapterView)
    {

    }

    @Override
    public void didReceivedNotification(int id, Object... args)
    {
        if (id == UiEventEntry.READ_DATA)
        {
            String result = (String) args[0];
            String content = (String) args[1];
            if (TextUtils.isEmpty(result) || TextUtils.isEmpty(content))
            {
                return;
            }
            setData(result);

//            if (result.contains("SetId_Type")) {
//                if (result.contains("OK SetId_Type")) {//设置站号类型成功
//
//                } else {
//                    is8Add = true;
//                    xingLinearLayout.setVisibility(View.GONE);
//                }
//            }

        }
        else if (id == UiEventEntry.SELECT_TIME)
        {
            String result = (String) args[0];
            rtuTimeTextView.setText(result);
            setTime = (String) args[1];
        }
    }

    private void setData(String result)
    {
        if (result.contains(ConfigParams.SetAddr.trim()))
        {// 遥测站地址：
            siteTestEditText.setText(result.replaceAll(ConfigParams.SetAddr.trim(), "").trim());
        }
        else if (result.contains(ConfigParams.SetRTUid18.trim()))
        {// 设备ID
            deviceEditText.setText(result.replaceAll(ConfigParams.SetRTUid18.trim(), "").trim());
        }
        else if (result.contains(ConfigParams.elecrelay.trim()))
        {// 设备ID
            String data = result.replaceAll(ConfigParams.elecrelay.trim(), "").trim();
            if ("0".equals(data))
            {
                elecrelaySwitch.setChecked(false);
            }
            else
            {
                elecrelaySwitch.setChecked(true);
            }
        }
        else if (result.contains(ConfigParams.SetStationMode.trim()))
        {// 站点类型：
            String site = result.replaceAll(ConfigParams.SetStationMode.trim(), "").trim();
            int siteNum = Integer.parseInt(site);
            if (siteNum <= 7)
            {
                siteTypeSpinner.setSelection(siteNum, false);
                siteTypeAdapter.setSelectedItem(siteNum);
            }
            else
            {
                siteTypeSpinner.setSelection(0, false);
                siteTypeAdapter.setSelectedItem(0);

            }
            siteTypeSpinner.setOnItemSelectedListener(this);
        }
        else if (result.contains(ConfigParams.SetWorkMode.trim()))
        {
            String s = result.replaceAll(ConfigParams.SetWorkMode.trim(), "").trim();
            if (TextUtils.isEmpty(s))
            {
                return;
            }
            if (s.equals("0"))
            {
                lowRadioButton.setChecked(true);
            }
            else if (s.equals("1"))
            {
                alwaysRadioButton.setChecked(true);
            }
        }
        else if (result.contains(ConfigParams.SETTIME.trim()))
        {
            String timeTemp = result.replaceAll(ConfigParams.SETTIME.trim(), "").trim();
            String time = timeTemp.replaceAll(" ", "0").trim();
            Log.info(TAG, "time:" + time);
            String rtuTime = ServiceUtils.getTime(time);
            if (rtuTimeTextView != null && rtuTime != null)
            {
                rtuTimeTextView.setText(rtuTime);
                setTime = time;
            }
        }
        else if (result.contains(ConfigParams.SetId_Type.trim()))
        {//区分8位站号和十位站号
            String s = result.replaceAll(ConfigParams.SetId_Type.trim(), "").trim();
            if (TextUtils.isEmpty(s))
            {
                return;
            }
            if ("0".equals(s))
            {//8位站号
                is8Add = true;
                siteNumRadioGroup.check(R.id.site_num_8);
                xingLinearLayout.setVisibility(View.GONE);
            }
            else if ("1".equals(s))
            {//10位站号
                is8Add = false;
                siteNumRadioGroup.check(R.id.site_num_10);
                xingLinearLayout.setVisibility(View.VISIBLE);
            }
        }
        else if (result.contains(ConfigParams.SetRTUidxz.trim()))
        {//10位站号行政区划码
//            if (is8Add)
//            {
//                return;
//            }
            xingEditText.setText(result.replaceAll(ConfigParams.SetRTUidxz.trim(), "").trim());
        }
        else if (result.contains(ConfigParams.SetRTUidyc.trim()))
        {//10位站号遥测站地址
            if (is8Add)
            {
                return;
            }
            siteTestEditText.setText(result.replaceAll(ConfigParams.SetRTUidyc.trim(), "").trim());
        }
    }
}
