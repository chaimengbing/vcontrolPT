package com.vcontrol.vcontroliot.fragment;

import android.app.UiAutomation;
import android.content.Intent;
import android.text.TextUtils;
import android.view.ContextThemeWrapper;
import android.view.View;
import android.widget.AdapterView;
import android.widget.Button;
import android.widget.EditText;
import android.widget.RadioGroup;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.Toast;

import com.vcontrol.vcontroliot.R;
import com.vcontrol.vcontroliot.VcontrolApplication;
import com.vcontrol.vcontroliot.act.FTPImageActivity;
import com.vcontrol.vcontroliot.adapter.SimpleSpinnerAdapter;
import com.vcontrol.vcontroliot.log.Log;
import com.vcontrol.vcontroliot.util.ConfigParams;
import com.vcontrol.vcontroliot.util.EventNotifyHelper;
import com.vcontrol.vcontroliot.util.FTPManager;
import com.vcontrol.vcontroliot.util.ProgressBarUtil;
import com.vcontrol.vcontroliot.util.ServiceUtils;
import com.vcontrol.vcontroliot.util.SocketUtil;
import com.vcontrol.vcontroliot.util.ToastUtil;
import com.vcontrol.vcontroliot.util.UiEventEntry;

import org.apache.commons.net.ftp.FTPFile;

import java.util.ArrayList;
import java.util.List;

/**
 * Created by Vcontrol on 2016/11/23.
 */

public class RcmSysPamarsFragment extends BaseFragment implements View.OnClickListener, EventNotifyHelper.NotificationCenterDelegate
{

    private static final String TAG = RcmSysPamarsFragment.class.getSimpleName();

    private String currentChannel = "1 ";
    private RadioGroup channelRadioGroup;
    private TextView channelText;
    private EditText ipChannel;
    private EditText portChannel;
    private EditText ftpAddrChannel;
    private EditText ftpPortChannel;

    private Button channelButton;
    private Button ftpAddrButton;


    private Spinner tfSpinner;
    private String[] tfItems;
    private SimpleSpinnerAdapter tfAdapter;

    private EditText photoInterval;

    private Button photoIntervalButton;
    private Button startupButton;
    private Button shutDownButton;
    private Button clearSDButton;
    private Button takePhotoButton;
    private Button ftpImageButton;

    private RadioGroup simConfigRadioGroup;


    @Override
    public int getLayoutView()
    {
        return R.layout.fragment_setting_rcm_system;
    }

    @Override
    public void onDestroy()
    {
        super.onDestroy();
        EventNotifyHelper.getInstance().removeObserver(this, UiEventEntry.READ_DATA);
    }

    @Override
    public void initComponentViews(View view)
    {

        EventNotifyHelper.getInstance().addObserver(this, UiEventEntry.READ_DATA);

        ipChannel = (EditText) view.findViewById(R.id.ip_channel_edittext);
        portChannel = (EditText) view.findViewById(R.id.port_channel_edittext);
        ftpAddrChannel = (EditText) view.findViewById(R.id.ftp_addr_edittext);
        ftpPortChannel = (EditText) view.findViewById(R.id.ftp_port_edittext);
        photoInterval = (EditText) view.findViewById(R.id.photo_interval_edittext);

        channelButton = (Button) view.findViewById(R.id.ip_channel_button);
        ftpAddrButton = (Button) view.findViewById(R.id.ftp_addr_button);
        channelText = (TextView) view.findViewById(R.id.ip_channel_text);

        channelRadioGroup = (RadioGroup) view.findViewById(R.id.ip_channel_group);

        photoIntervalButton = (Button) view.findViewById(R.id.photo_interval_button);
        shutDownButton = (Button) view.findViewById(R.id.shut_down);
        startupButton = (Button) view.findViewById(R.id.start_up);
        takePhotoButton = (Button) view.findViewById(R.id.take_photo);
        clearSDButton = (Button) view.findViewById(R.id.clear_sd_card);
        ftpImageButton = (Button) view.findViewById(R.id.ftp_imagelist_button);

        simConfigRadioGroup = (RadioGroup) view.findViewById(R.id.sim_config_radiogroup);
        tfSpinner = (Spinner) view.findViewById(R.id.tf_spinner);

        initView(view);

    }


    @Override
    public void initData()
    {
        SocketUtil.getSocketUtil().sendContent(ConfigParams.ReadData);

        tfItems = getResources().getStringArray(R.array.tf_time);
        tfAdapter = new SimpleSpinnerAdapter(getActivity(), R.layout.simple_spinner_item, tfItems);
        tfSpinner.setAdapter(tfAdapter);
    }

    private void initView(final View view)
    {
        channelRadioGroup.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener()
        {

            @Override
            public void onCheckedChanged(RadioGroup group, int checkedId)
            {

                View checkView = view.findViewById(checkedId);
                if (!checkView.isPressed())
                {
                    return;
                }
                if (checkedId == R.id.ip_channel_1)
                {
                    currentChannel = "1 ";
                    channelText.setText("IP通道1");
                }
                else if (checkedId == R.id.ip_channel_2)
                {
                    currentChannel = "2 ";
                    channelText.setText("IP通道2");
                }
                else if (checkedId == R.id.ip_channel_3)
                {
                    currentChannel = "3 ";
                    channelText.setText("IP通道3");
                }
                else if (checkedId == R.id.ip_channel_4)
                {
                    currentChannel = "4 ";
                    channelText.setText("IP通道4");
                }
                else if (checkedId == R.id.ip_channel_5)
                {
                    currentChannel = "5 ";
                    channelText.setText("IP通道5");
                }
                else if (checkedId == R.id.ip_channel_6)
                {
                    currentChannel = "6 ";
                    channelText.setText("IP通道6");
                }
            }
        });

        simConfigRadioGroup.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener()
        {

            @Override
            public void onCheckedChanged(RadioGroup group, int checkedId)
            {

                View checkView = view.findViewById(checkedId);
                if (!checkView.isPressed())
                {
                    return;
                }
                String content = "";
                if (checkedId == R.id.sim_config_telecom)
                {
                    content = ConfigParams.SetSIMConfig + "2";
                }
                else
                {
                    content = ConfigParams.SetSIMConfig + "1";
                }
                SocketUtil.getSocketUtil().sendContent(content);
            }
        });
    }

    @Override
    public void setListener()
    {
        channelButton.setOnClickListener(this);
        ftpAddrButton.setOnClickListener(this);
        photoIntervalButton.setOnClickListener(this);
        shutDownButton.setOnClickListener(this);
        takePhotoButton.setOnClickListener(this);
        startupButton.setOnClickListener(this);
        clearSDButton.setOnClickListener(this);
        ftpImageButton.setOnClickListener(this);
    }


    @Override
    public void onClick(View view)
    {
        String data = "";
        String port = "";
        String content = "";
        switch (view.getId())
        {
            case R.id.ip_channel_button:
                data = ipChannel.getText().toString().trim();
                port = portChannel.getText().toString().trim();
                if (TextUtils.isEmpty(data))
                {
                    ToastUtil.showToastLong("IP或端口不能为空！");
                    return;
                }
                content = ConfigParams.SetIPChannel + currentChannel + data + " " + ConfigParams.Port + port;
                break;

            case R.id.ftp_addr_button:
                data = ftpAddrChannel.getText().toString().trim();
                port = ftpPortChannel.getText().toString().trim();
                if (TextUtils.isEmpty(data) || TextUtils.isEmpty(port))
                {
                    ToastUtil.showToastLong("地址或端口不能为空！");
                    return;
                }
                content = ConfigParams.SetFTPAddr + data + " " + ConfigParams.Port + port;

                break;
            case R.id.photo_interval_button:

                data = photoInterval.getText().toString().trim();
                if (TextUtils.isEmpty(data))
                {
                    ToastUtil.showToastLong("拍照间隔不能为空！");
                    return;
                }

                content = ConfigParams.SetTakePhotoInterval + data;
                break;

            case R.id.shut_down:
                content = ConfigParams.ShutDown;
                break;
            case R.id.start_up:
                content = "";
                startupStatus();
                break;
            case R.id.take_photo:
                content = ConfigParams.SetTakePhoto;

                break;
            case R.id.ftp_imagelist_button:

                Intent intent = new Intent(getActivity(),FTPImageActivity.class);
                getActivity().startActivity(intent);


                break;
            case R.id.clear_sd_card:
                content = ConfigParams.SetClearSDCard;
                break;

            default:
                content = "";
                break;
        }

        SocketUtil.getSocketUtil().sendContent(content);
    }

    private Runnable timeRunnable = new Runnable()
    {
        @Override
        public void run()
        {
            sendData();
            VcontrolApplication.applicationHandler.postDelayed(timeRunnable, UiEventEntry.TIME);
        }
    };

    private void sendData()
    {
        SocketUtil.getSocketUtil().sendContent(ConfigParams.ReadStatus);
    }

    private void startupStatus()
    {
        SocketUtil.getSocketUtil().sendContent(ConfigParams.StartUp);
        ProgressBarUtil.showProgressDialog(getActivity(),"正在开机...","");
        VcontrolApplication.applicationHandler.postDelayed(timeRunnable, UiEventEntry.TIME);
    }


    @Override
    public void didReceivedNotification(int id, Object... args)
    {
        if (id == UiEventEntry.READ_DATA)
        {
            String result = (String) args[0];
            String content = (String) args[1];
            if (TextUtils.isEmpty(result) || TextUtils.isEmpty(content))
            {
                return;
            }
            setData(result);

        }
    }

    private void setData(String result)
    {
        String data;
        String ip;
        if (result.contains(ConfigParams.SetFTPAddr.trim()))
        {//
            String[] portArray = result.split(ConfigParams.Port.trim());
            ftpAddrChannel.setText(ServiceUtils.getRemoteIp(portArray[0].replaceAll(ConfigParams.SetFTPAddr, "").trim()));
            if (portArray.length > 1)
            {
                ftpPortChannel.setText(portArray[1].trim());
            }
        }
        else if (result.contains(ConfigParams.SetTakePhotoInterval.trim()))
        {// 拍照时间间隔
            data = result.replaceAll(ConfigParams.SetTakePhotoInterval, "");
            photoInterval.setText(data.trim());
        }
        else if (result.contains(ConfigParams.SetVideoSave.trim()))
        {// 录像时间间隔
            data = result.replaceAll(ConfigParams.SetVideoSave, "");
            int i = Integer.parseInt(data);
            if (i < tfItems.length && i > 0)
            {
                tfSpinner.setSelection(i);
            }
            tfSpinner.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener()
            {
                @Override
                public void onItemSelected(AdapterView<?> parent, View view, int position, long id)
                {
                    tfAdapter.setSelectedItem(position);
                    String content = ConfigParams.SetVideoSave + position;
                    SocketUtil.getSocketUtil().sendContent(content);
                }

                @Override
                public void onNothingSelected(AdapterView<?> parent)
                {

                }
            });
        }
        else if (result.contains("System Up"))
        {// 开机完成
            ProgressBarUtil.dismissProgressDialog();
            VcontrolApplication.applicationHandler.removeCallbacks(timeRunnable);
        }
        else if (result.contains("System Down"))
        {// 正在开机

        }

    }


}
